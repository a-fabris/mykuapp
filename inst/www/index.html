<!-- index.html -->
<!doctype html>
<html>
	
<head>  
   <!-- META -->
	<meta charset="utf-8">

    <!-- js -->
    <script type="text/javascript" src="bower_components/jquery/dist/jquery.min.js"></script> <!-- jquery -->
    <script type="text/javascript" src="bower_components/d3/d3.js"></script> <!-- d3.js data visualization -->
    <script type="text/javascript" src="bower_components/opencpu/opencpu-0.5.js"></script>

    <script type="text/javascript" src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script> <!-- bootstrap -->
    <script type="text/javascript" src="bower_components/handsontable/dist/handsontable.full.js"></script> <!-- handsontable -->
    <script type="text/javascript" src="bower_components/papaparse/papaparse.js"></script> <!-- papa parse csv to json -->


    <!-- CSS -->
    <link rel="stylesheet" media="screen" href="bower_components/bootstrap/dist/css/bootstrap.css"><!-- bootstrap -->
    <link rel="stylesheet" media="screen" href="bower_components/font-awesome/css/font-awesome.css"><!-- font awesome -->
    <link rel="stylesheet" media="screen" href="bower_components/handsontable/dist/handsontable.full.css"><!-- handsontable -->

    <style type="text/css">
    	#data-container { height: 350px; width: 100%; overflow: hidden;}
    	#vis-area {height: 350px; width: 100%; margin: 5px;}
    </style>
</head>

<body>
	<div class="container-fluid">
		<div class="row"> <!-- header -->
			<div class="col-md-4">
				<h4>Thesis Prototype <small>Andrea Fabris</small></h4>
			</div>
			<div class="col-md-1 col-md-offset-7">
				<button type="button" class="btn btn-default"><i class="fa  fa-question fa-2x"></i></button>
			</div>
		</div>

		<div class="row">
			<input type="file" name="csv" id="csvfile">
			<button class="btn btn-default" type="button" onClick="readCSV()">Load table</button>
			<button class="btn btn-default" type="button" id="plotFromR">GGPlot distribution</button>
		</div>

		<div class="row">
			<div class="col-md-10">
				<div class="row" id="vis-area"> <!-- plot placeholder -->
				</div>
				<div class="row">
					<div class="col-md-12">
						<div class="btn-group btn-group-lg" role="group" aria-label="..." id="data-features">
						</div>
					</div>
				</div>
				<div class="row" id="data-container"> <!-- data placeholder -->
				</div>
			</div>
			<div class="col-md-2" id="transcript"> <!-- code transcript -->
			</div>
		</div>

	</div>
</body>

<script>

var container = document.getElementById('data-container');

var cerealData; 

var setVariables = []; //array to store the data variables

var isChecked;

//call R function: stocks::smoothplot(ticker=ticker)
$("#plotFromR").click(function(){
    //var ticker = $("#ticker").val();

    //ocpu.seturl("https://public.opencpu.org/ocpu/library/ggplot2/R");

    var req = $("#vis-area").rplot("qplot", {
    	x : "calories",
        data : UScereal,
        geom : "histogram"
    });
    
    //optional
    req.fail(function(){
        alert("R returned an error: " + req.responseText); 
    });
});

    var hot = new Handsontable(container, {
		//startRows: 8,
    	//startCols: 6,
    	rowHeaders: true,
    	contextMenu: true,
    	customBorders: true,
		manualColumnMove: true,
    	manualRowMove: true
	});

    function readCSV(){
		
		// Parse local CSV file
		var cereal = $("#csvfile")[0].files[0];
		
		Papa.parse(cereal, {
			
			complete: function(results) {
		
				cerealData = results.data;

				//console.log(results.data);

				hot.updateSettings({colHeaders : results.data[0]});

				hot.loadData(results.data);

				for(var i = 0 ; i < results.data[0].length ; i++){
					$( "#data-features" ).append( "<button type='button' class='btn btn-default' id='btn_" +results.data[0][i] + "''>"+ results.data[0][i] +"</button>" );	
				}


    			$(document).ready(function(){

    				$("button").click(function(event){
    					var btnId = event.target.id;
    					plotFromFeature(btnId);
    				});

    				/*
					$("#btn_calories").click(function(){
    					console.log("clicked");
    					d3Plot();
    				});
					*/

				}); // .document.ready

			}			
		});
    }

    function plotFromFeature(btnId){
    	var feature = btnId.substring(4);
    	console.log("feature from id: " + feature);

    	/*logic to show the single plot*/

    	d3Plot(feature);
    }

    function d3Plot(featureToPlot){
    	
    	console.log("printing feature to plot val: " + featureToPlot.val);

    	var width = 300,
    		height= 300,
    		padding = 50
    		bins = 15;

    	d3.csv("data/UScereal.csv", function(data){

    		console.log("printing feature to plot val in csv: " + featureToPlot.val);

    		var feature = data.map(function(i){ return parseInt(i.calories); })



    		//console.log("feature to plot: " + featureToPlot + " data: " + feature );

    		var histogram = d3.layout.histogram()
    			.bins(bins)
				(feature)

			var y = d3.scale.linear()
				.domain([0, d3.max(histogram.map(function(i){ return i.length; }))])
				.range([0, height]);

			var x = d3.scale.linear()
				.domain([0, d3.max(feature)])
				.range([0, width]);

			var xAxis = d3.svg.axis()
				.scale(x)
				.orient("bottom");

			var canvas = d3.select("#vis-area").append("svg")
				.attr("width",width)
				.attr("height",height + padding)
				.append("g")
					.attr("transform","translate(20,0)");

			var group = canvas.append("g")
				.attr("transform", "translate(0," + height + ")")
				.call(xAxis);

			var bars = canvas.selectAll(".bar")
				.data(histogram)
				.enter()
				.append("g");

-			bars.append("rect")
				.attr("x", function(d){ return x(d.x); })
				.attr("y", function(d){ return height - y(d.y)})
				.attr("width", function(d){ return x(d.dx); })
				.attr("height", function(d){ return y(d.y); })
				.attr("fill", "steelblue");

			bars.append("text")
				.attr("x", function(d){ return x(d.x); })
				.attr("y", function(d){ return height - y(d.y)})
				.attr("dy", "20px")
				.attr("dx", function(d){ return x(d.dx)/2; })
				.attr("fill","#fff")
				.attr("text-anchor", "middle")
				.text(function(d){ return d.y; }); //returns the number of elements
    	});
    }

</script>

</html>